{"version":3,"sources":["model.ts","controller.ts","App.tsx","serviceWorker.ts","index.tsx"],"names":["bgMat","edgeMat","labelMat","bgRoi","edgeRoi","labelRoi","display","hist","Pos","dist","v1","v2","Math","sqrt","pow","add","sub","mul","v","m","sum","vecs","reduce","prev","curr","nbrs","p","closeNbrs","getVal","mat","pos","cols","rows","ucharPtr","fallPos","earlyStop","curPos","curVal","r","vals","map","maxNbrVal","max","maxNbrs","i","filter","_","includes","direction","length","dists","indexOf","min","isBranch","changes","selectTillBranch","inclusive","res","stack","visited","push","pop","toString","edgeNbrs","branchedNbrs","forEach","needRepair","fillSelect","mats","hitWall","setVal","val","set","growValley","cv","threshold","THRESH_BINARY","Mat","ones","CV_8U","dilated","dilate","Point","BORDER_CONSTANT","morphologyDefaultBorderValue","addWeighted","delete","deleteRois","deleteMats","undefined","DEFAULT_ROI_RANGE","DEFAULT_COMPOSE","showBg","bgWeight","showEdge","showEdgeValley","edgeWeight","showLabel","labelColor","labelWeight","composeUpdate","Subject","composeStore","BehaviorSubject","roiUpdate","roiStore","width","height","x","y","initedStore","srcUpdate","edgeUpdate","labelUpdate","displayUpdate","SrcSize","RoiRange","undo","h","next","roi","update","isUndo","fitRange","n","restrictRoi","w","pipe","value","subscribe","isResize","invalidResize","distinctUntilChanged","isInit","JSON","stringify","pluck","tap","zeros","type","src","imread","cvtColor","COLOR_RGB2GRAY","Canny","dimBy","targets","isSet","labelThresed","imshow","outputLabel","config","setTo","edgeCvted","COLOR_GRAY2RGBA","labelCvted","labelColorInv","c","subtract","composeDisplay","color","amount","dimMask","ValidCursorModes","0","1","2","3","4","ComposeConfigs","5","CursorColors","getRelPos","canvas","e","rect","getBoundingClientRect","clientX","left","clientY","top","getRoiPos","relPos","floor","App","useState","isFocused","setFocused","actionMode","setActionMode","cursorMode","setCursorMode","isMouseDown","setMouseDown","movePrevPos","setMovePrevPos","isMovingCanvas","setMovingCanvas","setRoi","inited","setInited","composeConfig","setComposeConfig","imageSrc","useRef","labelOutput","useEffect","window","addEventListener","roiSub","initedSub","composeSub","removeEventListener","unsubscribe","downloadLabel","useCallback","link","document","createElement","download","href","current","toDataURL","click","doAction","pressed","range","j","setModes","newCursorMode","newActionMode","onImageLoad","currentTarget","onCanvasMouseEnter","onCanvasMouseLeave","onCanvasMouseMove","onCanvasMouseDown","onCanvasMouseUp","onCanvasKeyPress","key","onCanvasKeyDown","onCanvasKeyUp","onCanvasFocus","onCanvasBlur","onCanvasWheel","preventDefault","oldPos","newRoi","deltaY","ceil","newPos","actionRow","useMemo","align","span","Group","onChange","target","disabled","Button","miscRow","checked","unCheckedChildren","checkedChildren","className","ghost","onClick","appearanceRow","offset","step","id","alt","ref","onLoad","style","name","URL","createObjectURL","files","onMouseEnter","onMouseLeave","onMouseMove","onMouseDown","onMouseUp","onKeyPress","onFocus","onBlur","onWheel","onKeyDown","onKeyUp","tabIndex","Boolean","location","hostname","match","ReactDOM","render","StrictMode","getElementById","navigator","serviceWorker","ready","then","registration","unregister","catch","error","console","message"],"mappings":"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","file":"static/js/main.3216f223.chunk.js","sourcesContent":["declare const cv: any\r\n\r\nvar bgMat: any\r\nvar edgeMat: any\r\nvar labelMat: any\r\n\r\nvar bgRoi: any\r\nexport var edgeRoi: any\r\nexport var labelRoi: any\r\nexport var display: any\r\n\r\nexport type ComposeConfig = {\r\n    showBg: boolean\r\n    bgWeight: number,\r\n    showEdge: boolean,\r\n    showEdgeValley: boolean,\r\n    edgeWeight: number,\r\n    showLabel: boolean,\r\n    labelColor: number[],\r\n    labelWeight: number,\r\n}\r\n\r\nexport const Pos = {\r\n    dist: (v1: number[], v2: number[]) => Math.sqrt(Math.pow(v1[0] - v2[0], 2) + Math.pow(v1[1] - v2[1], 2)),\r\n    add: (v1: number[], v2: number[]) => [v1[0] + v2[0], v1[1] + v2[1]],\r\n    sub: (v1: number[], v2: number[]) => [v1[0] - v2[0], v1[1] - v2[1]],\r\n    mul: (v: number[], m: number) => [v[0] * m, v[1] * m],\r\n    sum: (vecs: number[][]) => vecs.reduce((prev, curr) => Pos.add(prev, curr), [0, 0]),\r\n    nbrs: (p: number[]) => [\r\n        [p[0] - 1, p[1] - 1], [p[0], p[1] - 1], [p[0] + 1, p[1] - 1], [p[0] + 1, p[1]],\r\n        [p[0] + 1, p[1] + 1], [p[0], p[1] + 1], [p[0] - 1, p[1] + 1], [p[0] - 1, p[1]]\r\n    ],\r\n    closeNbrs: (p: number[]) => [\r\n        [p[0], p[1] - 1], [p[0] + 1, p[1]],\r\n        [p[0], p[1] + 1], [p[0] - 1, p[1]]\r\n    ],\r\n}\r\n\r\nexport const getVal = (mat: any, pos: number[]) => {\r\n    if (pos[0] >= 0 && pos[1] >= 0 && pos[0] < mat.cols && pos[1] < mat.rows)\r\n        return mat.ucharPtr(pos[0], pos[1])[0] as number\r\n    return 0\r\n}\r\n\r\nexport const fallPos = (mat: any, pos: number[], earlyStop = false) => {\r\n    let [curPos, curVal] = [pos, getVal(mat, pos)]\r\n    if (curVal === 0) return curPos\r\n    for (let r = 0; r < 20; r++) {\r\n        let nbrs = Pos.nbrs(curPos)\r\n        let vals = nbrs.map(pos => getVal(mat, pos))\r\n        const maxNbrVal = Math.max(...vals)\r\n        if (maxNbrVal === curVal) break\r\n        const maxNbrs = vals.map((v, i) => v === maxNbrVal ? i : -1).filter(i => i > -1)\r\n        if (earlyStop && maxNbrVal === 255) break\r\n        vals = vals.filter((_, i) => maxNbrs.includes(i))\r\n        nbrs = nbrs.filter((_, i) => maxNbrs.includes(i))\r\n        const direction = Pos.sub(Pos.mul(Pos.sum(nbrs), 1 / maxNbrs.length), curPos)\r\n        const dists = nbrs.map(pos => Pos.dist(pos, direction))\r\n        curPos = nbrs[dists.indexOf(Math.min(...dists))]\r\n        curVal = maxNbrVal\r\n        if (curVal === 255) break\r\n    }\r\n    return curPos\r\n}\r\n\r\nconst isBranch = (mat: any, pos: number[]) => {\r\n    let nbrs = Pos.nbrs(pos)\r\n    let vals = nbrs.map(p => getVal(mat, p)).map(v => v === 255 ? 1 : 0)\r\n    let changes = 0\r\n    if ((vals[7] && vals[0] && vals[1]) ||\r\n        (vals[1] && vals[2] && vals[3]) ||\r\n        (vals[3] && vals[4] && vals[5]) ||\r\n        (vals[5] && vals[6] && vals[7])) return true\r\n    for (let i = 0; i < 8; i++) changes += vals[i] ^ vals[(i + 1) % 8]\r\n    return changes > 4\r\n}\r\n\r\nexport const selectTillBranch = (mat: any, pos: number[], inclusive = false) => {\r\n    if (getVal(mat, pos) !== 255) return []\r\n    if (isBranch(mat, pos)) return [pos]\r\n    const res: number[][] = []\r\n    const stack: number[][] = []\r\n    const visited: { [p: string]: boolean } = {}\r\n    stack.push(pos)\r\n    while (stack.length) {\r\n        let curPos = stack.pop()!\r\n        if (visited[curPos.toString()]) continue\r\n        visited[curPos.toString()] = true\r\n        res.push(curPos)\r\n        const edgeNbrs = Pos.nbrs(curPos).filter(p => getVal(mat, p) === 255)\r\n        const branchedNbrs = edgeNbrs.filter(p => isBranch(mat, p))\r\n        if (branchedNbrs.length) {\r\n            if (inclusive) branchedNbrs.forEach(p => res.push(p))\r\n            continue\r\n        }\r\n        edgeNbrs.forEach(p => stack.push(p))\r\n    }\r\n    return res\r\n}\r\n\r\nexport const needRepair = (mat: any[], pos: number[]) => {\r\n    if (getVal(mat, pos) === 255) return false\r\n    let nbrs = Pos.nbrs(pos)\r\n    let vals = nbrs.map(p => getVal(mat, p)).map(v => v === 255 ? 1 : 0)\r\n    const sum = vals.reduce((prev, curr) => prev + curr, 0 as number)\r\n    if (sum >= 7) return true\r\n    let changes = 0\r\n    for (let i = 0; i < 8; i++) changes += vals[i] ^ vals[(i + 1) % 8]\r\n    return changes >= 4\r\n}\r\n\r\nexport const fillSelect = (mats: any[], pos: number[]) => {\r\n    const hitWall = (p: number[]) => mats.filter(mat => getVal(mat, p) === 255).length > 0\r\n    if (hitWall(pos)) return []\r\n    const res: number[][] = []\r\n    const stack: number[][] = []\r\n    const visited: { [p: string]: boolean } = {}\r\n    stack.push(pos)\r\n    while (stack.length) {\r\n        let curPos = stack.pop()!\r\n        if (visited[curPos.toString()]) continue\r\n        visited[curPos.toString()] = true\r\n        res.push(curPos)\r\n        const nonEdgeNbrs = Pos.closeNbrs(curPos).filter(p => !hitWall(p))\r\n        nonEdgeNbrs.filter(p => !visited[p.toString()]).forEach(p => stack.push(p))\r\n        if (res.length > 1000) break\r\n    }\r\n    return res\r\n}\r\n\r\nexport const imshow = (mat: any) => cv.imshow('canvas', mat)\r\n\r\nexport const setVal = (mat: any, pos: number[], val: number[]) => {\r\n    if (pos[0] >= 0 && pos[1] >= 0 && pos[0] < mat.cols && pos[1] < mat.rows)\r\n        mat.ucharPtr(pos[0], pos[1]).set(val)\r\n}\r\n\r\nexport const dimBy = (mat: any, amount: number) => {\r\n    const dimMask = new cv.Mat(mat.rows, mat.cols, mat.type(), [0, 0, 0, amount])\r\n    cv.subtract(mat, dimMask, mat)\r\n    dimMask.delete()\r\n}\r\n\r\nexport const composeDisplay = (display: any, config: ComposeConfig) => {\r\n    display.setTo([0, 0, 0, 0])\r\n    if (config.showBg) cv.addWeighted(display, 1, bgRoi, config.bgWeight, 0.0, display)\r\n    if (config.showEdge) {\r\n        const edgeCvted = new cv.Mat.zeros(edgeRoi.rows, edgeRoi.cols, edgeRoi.type())\r\n        if (config.showEdgeValley) {\r\n            cv.add(edgeRoi, edgeCvted, edgeCvted)\r\n        } else {\r\n            cv.threshold(edgeRoi, edgeCvted, 254, 255, cv.THRESH_BINARY)\r\n        }\r\n        cv.cvtColor(edgeCvted, edgeCvted, cv.COLOR_GRAY2RGBA)\r\n        cv.addWeighted(display, 1, edgeCvted, config.edgeWeight, 0.0, display)\r\n        edgeCvted.delete()\r\n    }\r\n    if (config.showLabel) {\r\n        const labelThresed = new cv.Mat()\r\n        cv.threshold(labelRoi, labelThresed, 254, 255, cv.THRESH_BINARY)\r\n        const labelCvted = new cv.Mat()\r\n        cv.cvtColor(labelThresed, labelCvted, cv.COLOR_GRAY2RGBA)\r\n        const labelColorInv = new cv.Mat(labelCvted.rows, labelCvted.cols, labelCvted.type(), config.labelColor.map(c => 255 - c))\r\n        cv.addWeighted(display, 1, labelCvted, config.labelWeight, 0.0, display)\r\n        cv.subtract(display, labelColorInv, display, labelThresed)\r\n        labelThresed.delete()\r\n        labelCvted.delete()\r\n        labelColorInv.delete()\r\n    }\r\n}\r\n\r\nexport const outputLabel = () => {\r\n    const labelThresed = new cv.Mat()\r\n    cv.threshold(labelMat, labelThresed, 254, 255, cv.THRESH_BINARY)\r\n    cv.imshow('output', labelThresed)\r\n}\r\n\r\nexport const growValley = (mat: any) => {\r\n    cv.threshold(mat, mat, 254, 255, cv.THRESH_BINARY);\r\n    for (let i = 2; i < 6; i++) {\r\n        let filter = cv.Mat.ones(i, i, cv.CV_8U);\r\n        let dilated = new cv.Mat()\r\n        cv.dilate(mat, dilated, filter, new cv.Point(-1, -1), 1, cv.BORDER_CONSTANT, cv.morphologyDefaultBorderValue())\r\n        cv.addWeighted(mat, 0.8, dilated, 0.2, 0.0, mat);\r\n        filter.delete()\r\n        dilated.delete()\r\n    }\r\n}\r\n\r\nconst deleteRois = () => {\r\n    if (display) {\r\n        display.delete()\r\n        bgRoi.delete()\r\n        edgeRoi.delete()\r\n        labelRoi.delete()\r\n    }\r\n}\r\n\r\nexport const deleteMats = () => {\r\n    deleteRois()\r\n    display = bgRoi = edgeRoi = labelRoi = undefined\r\n    if (bgMat) {\r\n        bgMat.delete()\r\n        edgeMat.delete()\r\n        labelMat.delete()\r\n    }\r\n}\r\n\r\nexport const initMats = (src: HTMLImageElement) => {\r\n    deleteMats()\r\n    bgMat = cv.imread(src)\r\n    edgeMat = new cv.Mat()\r\n    cv.cvtColor(bgMat, edgeMat, cv.COLOR_RGB2GRAY, 0)\r\n    cv.Canny(edgeMat, edgeMat, 50, 100, 3, false)\r\n    labelMat = new cv.Mat.zeros(edgeMat.rows, edgeMat.cols, edgeMat.type())\r\n}\r\n\r\nexport const setRoi = (roi: any) => {\r\n    deleteRois()\r\n    display = new cv.Mat.zeros(roi.height, roi.width, bgMat.type())\r\n    bgRoi = bgMat.roi(roi)\r\n    edgeRoi = edgeMat.roi(roi)\r\n    labelRoi = labelMat.roi(roi)\r\n}\r\n","import { Subject, BehaviorSubject } from 'rxjs'\r\nimport { tap, filter, map, distinctUntilChanged, pluck } from 'rxjs/operators'\r\n\r\nimport { edgeRoi, labelRoi, display, imshow, setVal, growValley, composeDisplay, dimBy, initMats, setRoi, ComposeConfig, outputLabel } from './model'\r\n\r\ntype Roi = {\r\n    x: number,\r\n    y: number,\r\n    width: number,\r\n    height: number,\r\n}\r\n\r\ntype ComposeUpdate = {\r\n    showBg?: boolean\r\n    bgWeight?: number,\r\n    showEdge?: boolean,\r\n    showEdgeValley?: boolean,\r\n    edgeWeight?: number,\r\n    showLabel?: boolean,\r\n    labelColor?: number[],\r\n    labelWeight?: number,\r\n}\r\n\r\ntype RoiUpdate = {\r\n    isInit?: boolean,\r\n    isResize?: boolean,\r\n    roi: Roi,\r\n}\r\n\r\ntype DataUpdate = {\r\n    isUndo?: boolean,\r\n    targets?: number[][],\r\n    isSet?: boolean,\r\n}\r\n\r\ntype DisplayUpdate = {\r\n    targets?: number[][],\r\n    color?: number[],\r\n    dimBy?: number,\r\n}\r\n\r\ntype DataUpdateUndo = {\r\n    update: Subject<DataUpdate>,\r\n    roi: Roi,\r\n    targets: number[][],\r\n    isSet: boolean,\r\n}\r\n\r\nconst DEFAULT_ROI_RANGE = {\r\n    width: [16, 800],\r\n    height: [16, 800],\r\n}\r\n\r\nexport const getRoiRange = () => RoiRange\r\n\r\nexport const DEFAULT_COMPOSE: ComposeConfig = {\r\n    showBg: true,\r\n    bgWeight: 1,\r\n    showEdge: true,\r\n    showEdgeValley: false,\r\n    edgeWeight: 0.4,\r\n    showLabel: true,\r\n    labelColor: [255, 255, 0, 255],\r\n    labelWeight: 0.8,\r\n}\r\n\r\nexport const composeUpdate = new Subject<ComposeUpdate>()\r\nexport const composeStore = new BehaviorSubject<ComposeConfig>(DEFAULT_COMPOSE)\r\nexport const roiUpdate = new Subject<RoiUpdate>()\r\nexport const roiStore = new BehaviorSubject<Roi>({ width: -1, height: -1, x: -1, y: -1 })\r\nexport const initedStore = new BehaviorSubject<boolean>(false)\r\n\r\nexport const srcUpdate = new Subject<HTMLImageElement>()\r\nexport const edgeUpdate = new Subject<DataUpdate>()\r\nexport const labelUpdate = new Subject<DataUpdate>()\r\nexport const displayUpdate = new Subject<DisplayUpdate>()\r\n\r\nvar SrcSize = {\r\n    width: 0,\r\n    height: 0,\r\n}\r\n\r\nvar RoiRange = {\r\n    width: [0, 0],\r\n    height: [0, 0],\r\n}\r\n\r\nvar hist: DataUpdateUndo[]\r\n\r\nexport const undo = () => {\r\n    const h = hist.pop()\r\n    if (!h) return\r\n    roiUpdate.next({ roi: h.roi })\r\n    h.update.next({ ...h, isUndo: true })\r\n}\r\n\r\nconst fitRange = (r: number[], n: number) => n < r[0] ? r[0] : (n > r[1] ? r[1] : n)\r\n\r\nconst restrictRoi = (roi: Roi) => {\r\n    const w = fitRange(RoiRange.width, roi.width), h = fitRange(RoiRange.height, roi.height)\r\n    return {\r\n        width: w,\r\n        height: h,\r\n        x: fitRange([0, SrcSize.width - w - 1], roi.x),\r\n        y: fitRange([0, SrcSize.height - h - 1], roi.y),\r\n    }\r\n}\r\n\r\nconst invalidResize = (update: RoiUpdate) =>\r\n    update.isResize && (update.roi.width < RoiRange.width[0] || update.roi.width > RoiRange.width[1] || update.roi.height < RoiRange.height[0] || update.roi.height > RoiRange.height[1])\r\n\r\ncomposeUpdate\r\n    .pipe(\r\n        filter(() => initedStore.value),\r\n    )\r\n    .subscribe(update => composeStore.next({ ...composeStore.value, ...update }))\r\ncomposeStore\r\n    .subscribe(() => displayUpdate.next({}))\r\n\r\nroiUpdate\r\n    .pipe(\r\n        filter(update => !invalidResize(update)),\r\n        map(update => ({ ...update, roi: restrictRoi(update.roi) })),\r\n        distinctUntilChanged((prev, curr) => !curr.isInit && JSON.stringify(prev.roi) === JSON.stringify(curr.roi)),\r\n        pluck(\"roi\"),\r\n        tap(setRoi)\r\n    )\r\n    .subscribe(roi => roiStore.next(roi))\r\nroiStore\r\n    .subscribe(() => edgeUpdate.next({}))\r\n\r\nsrcUpdate\r\n    .pipe(\r\n        tap(() => initedStore.next(false)),\r\n        tap(initMats)\r\n    )\r\n    .subscribe(src => {\r\n        SrcSize = {\r\n            width: src.width,\r\n            height: src.height\r\n        }\r\n        RoiRange = {\r\n            width: [16, Math.min(DEFAULT_ROI_RANGE.width[1], SrcSize.width)],\r\n            height: [16, Math.min(DEFAULT_ROI_RANGE.height[1], SrcSize.height)]\r\n        }\r\n        roiUpdate.next({ isInit: true, roi: { x: 0, y: 0, width: Math.min(400, src.width), height: Math.min(400, src.height) } })\r\n        growValley(edgeRoi)\r\n        displayUpdate.next({ dimBy: 96 })\r\n        hist = []\r\n        initedStore.next(true)\r\n    })\r\n\r\nedgeUpdate\r\n    .pipe(\r\n        filter(() => initedStore.value),\r\n    )\r\n    .subscribe(update => {\r\n        if (update.targets?.length) {\r\n            update.targets.forEach(p => setVal(edgeRoi, p, [update.isSet ? 255 : 0]))\r\n            if (!update.isUndo) hist.push({ update: edgeUpdate, roi: roiStore.value, targets: update.targets!, isSet: !update.isSet! })\r\n        }\r\n        growValley(edgeRoi)\r\n        displayUpdate.next({})\r\n    })\r\n\r\nlabelUpdate\r\n    .pipe(\r\n        filter(() => initedStore.value),\r\n    )\r\n    .subscribe(update => {\r\n        if (update.targets?.length) {\r\n            update.targets.forEach(p => setVal(labelRoi, p, [update.isSet ? 255 : 0]))\r\n            if (!update.isUndo) hist.push({ update: labelUpdate, roi: roiStore.value, targets: update.targets!, isSet: !update.isSet! })\r\n        }\r\n        outputLabel()\r\n        displayUpdate.next({})\r\n    })\r\n\r\ndisplayUpdate\r\n    .pipe(\r\n        filter(() => initedStore.value),\r\n        tap(() => composeDisplay(display, composeStore.value)),\r\n    )\r\n    .subscribe(update => {\r\n        if (update.targets?.length) update.targets.forEach(p => setVal(display, p, update.color!))\r\n        if (update.dimBy) dimBy(display, update.dimBy)\r\n        imshow(display)\r\n    })\r\n","import React, { useRef, SyntheticEvent, MouseEvent, KeyboardEvent, WheelEvent, useState, useCallback, useEffect, useMemo } from 'react'\nimport { Radio, Button, Switch, Col, Row, Slider } from 'antd'\nimport 'antd/dist/antd.css'\n\nimport { srcUpdate, edgeUpdate, labelUpdate, displayUpdate, roiUpdate, composeUpdate, initedStore, roiStore, composeStore, DEFAULT_COMPOSE, undo } from './controller'\nimport { edgeRoi, labelRoi, getVal, fallPos, selectTillBranch, fillSelect, needRepair, deleteMats } from './model'\nimport './App.css'\n\ntype ActionMode = 0 | 1 | 2 | 3 | 4\nconst NO_ACTION: ActionMode = 0\nconst WIPE_EDGE: ActionMode = 1\nconst DRAW_EDGE: ActionMode = 2\nconst REPAIR_EDGE: ActionMode = 3\nconst FILL_LABEL: ActionMode = 4\n\ntype CursorMode = 0 | 1 | 2 | 3\nconst DISABLED = 0\nconst FALLING = 1\nconst ADHERE = 2\nconst FLOATING = 3\n\nconst ValidCursorModes = {\n    0: [FALLING, ADHERE, FLOATING],\n    1: [FALLING, FLOATING],\n    2: [ADHERE, FLOATING],\n    3: [FLOATING],\n    4: [FLOATING],\n}\n\nconst ComposeConfigs = {\n    0: DEFAULT_COMPOSE,\n    1: { ...DEFAULT_COMPOSE, showEdgeValley: true, bgWeight: 0.5 },\n    2: { ...DEFAULT_COMPOSE, bgWeight: 0.8, edgeWeight: 0.8 },\n    3: { ...DEFAULT_COMPOSE, bgWeight: 0.8, edgeWeight: 0.8 },\n    4: { ...DEFAULT_COMPOSE, bgWeight: 0.6 },\n    5: { ...DEFAULT_COMPOSE, showEdge: false, labelWeight: 0.4 },\n}\n\nconst CursorColors = {\n    0: [0, 0, 0, 0],\n    1: [0, 255, 255, 255],\n    2: [255, 0, 255, 255],\n    3: [255, 0, 0, 255],\n}\n\nconst getRelPos = (canvas: HTMLCanvasElement, e: React.MouseEvent<HTMLCanvasElement>) => {\n    const rect = canvas.getBoundingClientRect()\n    return [(e.clientX - rect.left) / rect.width, (e.clientY - rect.top) / rect.height]\n}\n\nconst getRoiPos = (roi: any, relPos: number[]) => {\n    const res = relPos.map((p, i) => Math.floor(p * [roi.width, roi.height][i]))\n    return [res[1], res[0]]\n}\n\nexport default function App() {\n    const [isFocused, setFocused] = useState(false)\n    const [actionMode, setActionMode] = useState<ActionMode>(NO_ACTION)\n    const [cursorMode, setCursorMode] = useState<CursorMode>(FALLING)\n    const [isMouseDown, setMouseDown] = useState(false)\n    const [movePrevPos, setMovePrevPos] = useState([-1, -1])\n    const [isMovingCanvas, setMovingCanvas] = useState(false)\n    const [roi, setRoi] = useState(roiStore.value)\n    const [inited, setInited] = useState(initedStore.value)\n    const [composeConfig, setComposeConfig] = useState(composeStore.value)\n    const imageSrc = useRef<HTMLImageElement>(null)\n    const labelOutput = useRef<HTMLCanvasElement>(null)\n\n    useEffect(() => {\n        window.addEventListener(\"beforeunload\", deleteMats);\n        const roiSub = roiStore.subscribe(setRoi)\n        const initedSub = initedStore.subscribe(setInited)\n        const composeSub = composeStore.subscribe(setComposeConfig)\n        return () => {\n            window.removeEventListener(\"beforeunload\", deleteMats);\n            roiSub.unsubscribe()\n            initedSub.unsubscribe()\n            composeSub.unsubscribe()\n        }\n    }, [])\n\n    const downloadLabel = useCallback(() => {\n        const link = document.createElement('a')\n        link.download = 'label.png'\n        link.href = labelOutput.current?.toDataURL(\"image/png\")!\n        link.click();\n    }, [])\n\n    const doAction = useCallback((pos: number[], pressed = false) => {\n        if (isMovingCanvas) {\n            if (!isMouseDown || movePrevPos[0] === -1) return\n            roiUpdate.next({\n                roi: {\n                    ...roi,\n                    x: roi.x + movePrevPos[1] - pos[1],\n                    y: roi.y + movePrevPos[0] - pos[0],\n                }\n            })\n        } else {\n            let targets: number[][]\n            switch (cursorMode) {\n                case DISABLED:\n                    targets = []\n                    break\n                case FLOATING:\n                    targets = [pos]\n                    break\n                case FALLING:\n                    targets = selectTillBranch(edgeRoi, fallPos(edgeRoi, pos))\n                    break\n                case ADHERE:\n                    targets = [fallPos(edgeRoi, pos, true)].filter(p => getVal(edgeRoi, p))\n            }\n            if (actionMode === NO_ACTION || !(isMouseDown || pressed)) {\n                displayUpdate.next({ targets: targets, color: CursorColors[cursorMode] })\n            } else {\n                if (!targets.length) return\n                switch (actionMode) {\n                    case WIPE_EDGE:\n                        targets = targets.filter(p => getVal(edgeRoi, p) === 255)\n                        edgeUpdate.next({ isSet: false, targets: targets })\n                        break\n                    case DRAW_EDGE:\n                        edgeUpdate.next({ isSet: true, targets: targets })\n                        break\n                    case REPAIR_EDGE:\n                        const p = targets.pop()!\n                        const range = 20\n                        for (let i = p[0] - range; i < p[0] + range; i++)\n                            for (let j = p[1] - range; j < p[1] + range; j++)\n                                targets.push([i, j])\n                        targets = targets.filter(p => needRepair(edgeRoi, p))\n                        edgeUpdate.next({ isSet: true, targets: targets })\n                        break\n                    case FILL_LABEL:\n                        targets = fillSelect([edgeRoi, labelRoi], targets[0])\n                        labelUpdate.next({ isSet: true, targets: targets })\n                }\n                if (!targets.length) return\n            }\n        }\n    }, [roi, actionMode, cursorMode, isMouseDown, movePrevPos, isMovingCanvas])\n\n    const setModes = useCallback((newCursorMode: CursorMode, newActionMode: ActionMode) => {\n        if (cursorMode !== newCursorMode) {\n            while (ValidCursorModes[newActionMode].indexOf(newCursorMode) < 0)\n                newCursorMode = (newCursorMode + 1) % 4 as CursorMode\n            setCursorMode(newCursorMode)\n        }\n        if (actionMode !== newActionMode) {\n            setActionMode(newActionMode)\n            setCursorMode(ValidCursorModes[newActionMode][0] as CursorMode)\n            composeUpdate.next(ComposeConfigs[newActionMode])\n        }\n    }, [cursorMode, actionMode])\n\n    const onImageLoad = useCallback((e: SyntheticEvent<HTMLImageElement, Event>) => {\n        srcUpdate.next(e.currentTarget)\n    }, [])\n\n    const onCanvasMouseEnter = useCallback((e: MouseEvent<HTMLCanvasElement>) => {\n        if (!inited) return\n        if (!isFocused) displayUpdate.next({ dimBy: 64 })\n    }, [inited, isFocused])\n\n    const onCanvasMouseLeave = useCallback((e: MouseEvent<HTMLCanvasElement>) => {\n        if (!inited) return\n        setMouseDown(false)\n        setMovePrevPos([-1, -1])\n        if (!isFocused) displayUpdate.next({ dimBy: 96 })\n    }, [inited, isFocused])\n\n    const onCanvasMouseMove = useCallback((e: MouseEvent<HTMLCanvasElement>) => {\n        if (!inited) return\n        if (!isFocused) return\n        const pos = getRoiPos(roi, getRelPos(e.currentTarget, e))\n        if (pos.toString() === movePrevPos.toString()) return\n        doAction(pos)\n        setMovePrevPos(pos)\n    }, [inited, roi, isFocused, movePrevPos, doAction])\n\n    const onCanvasMouseDown = useCallback((e: MouseEvent<HTMLCanvasElement>) => {\n        if (!inited) return\n        setMovePrevPos([-1, -1])\n        if (!isFocused) return\n        setMouseDown(true)\n        if (actionMode === NO_ACTION) return\n        const pos = getRoiPos(roi, getRelPos(e.currentTarget, e))\n        doAction(pos, true)\n    }, [inited, roi, isFocused, actionMode, doAction])\n\n    const onCanvasMouseUp = useCallback((e: MouseEvent<HTMLCanvasElement>) => {\n        if (!inited) return\n        setMouseDown(false)\n    }, [inited])\n\n    const onCanvasKeyPress = useCallback((e: KeyboardEvent<HTMLCanvasElement>) => {\n        if (!inited || isMovingCanvas) return\n        setMovePrevPos([-1, -1])\n        let newCursorMode: CursorMode = cursorMode, newActionMode: ActionMode = actionMode\n        switch (e.key) {\n            case \"q\": break\n            case \"f\":\n                newCursorMode = (cursorMode + 1) % 4 as CursorMode\n                break\n            case \"z\":\n                undo()\n                break\n            case \"s\":\n                downloadLabel()\n                break\n            case \"w\":\n                newActionMode = WIPE_EDGE\n                break\n            case \"e\":\n                newActionMode = DRAW_EDGE\n                break\n            case \"r\":\n                newActionMode = REPAIR_EDGE\n                break\n            case \"d\":\n                newActionMode = FILL_LABEL\n                break\n            default:\n                newActionMode = NO_ACTION\n        }\n        setModes(newCursorMode, newActionMode)\n    }, [inited, isMovingCanvas, actionMode, cursorMode, setModes, downloadLabel])\n\n    const onCanvasKeyDown = useCallback((e: KeyboardEvent<HTMLCanvasElement>) => {\n        if (!inited) return\n        switch (e.key) {\n            case \"q\":\n                setMovingCanvas(true)\n                break\n        }\n    }, [inited])\n\n    const onCanvasKeyUp = useCallback((e: KeyboardEvent<HTMLCanvasElement>) => {\n        if (!inited) return\n        switch (e.key) {\n            case \"q\":\n                setMovingCanvas(false)\n                break\n        }\n    }, [inited])\n\n    const onCanvasFocus = useCallback(() => {\n        if (!inited) return\n        setFocused(true)\n        displayUpdate.next({})\n    }, [inited])\n\n    const onCanvasBlur = useCallback(() => {\n        if (!inited) return\n        setFocused(false)\n        setMouseDown(false)\n        setMovePrevPos([-1, -1])\n        displayUpdate.next({ dimBy: 96 })\n    }, [inited])\n\n    const onCanvasWheel = useCallback((e: WheelEvent<HTMLCanvasElement>) => {\n        if (!inited || !isMovingCanvas) return\n        e.preventDefault()\n        const relPos = getRelPos(e.currentTarget, e)\n        const oldPos = getRoiPos(roi, relPos)\n        const newRoi = {\n            ...roi,\n            width: e.deltaY > 0 ? Math.ceil(roi.width * 1.05) : Math.floor(roi.width * 0.95),\n            height: e.deltaY > 0 ? Math.ceil(roi.height * 1.05) : Math.floor(roi.height * 0.95),\n        }\n        const newPos = getRoiPos(newRoi, relPos)\n        roiUpdate.next({\n            isResize: true,\n            roi: {\n                ...newRoi,\n                x: roi.x + oldPos[1] - newPos[1],\n                y: roi.y + oldPos[0] - newPos[0],\n            }\n        })\n    }, [inited, roi, isMovingCanvas])\n\n    const actionRow = useMemo(() => (\n        <Row align={\"middle\"}>\n            <Col span={24} >\n                <span>Action: </span>\n                <Radio.Group value={actionMode} onChange={(e) => setModes(cursorMode, e.target.value)} disabled={!inited}>\n                    <Radio.Button value={NO_ACTION}>No Action</Radio.Button>\n                    <Radio.Button value={WIPE_EDGE}>Wipe Edge (W)</Radio.Button>\n                    <Radio.Button value={DRAW_EDGE}>Draw Edge (E)</Radio.Button>\n                    <Radio.Button value={REPAIR_EDGE}>Repair Edge (R)</Radio.Button>\n                    <Radio.Button value={FILL_LABEL}>Fill Label (D)</Radio.Button>\n                </Radio.Group>\n            </Col>\n        </Row>\n    ), [inited, actionMode, cursorMode, setModes])\n\n    const miscRow = useMemo(() => (\n        <Row align={\"middle\"}>\n            <Col span={4}>\n                <span>Move Canvas: </span>\n                <Switch\n                    checked={isMovingCanvas}\n                    unCheckedChildren={\"Q\"}\n                    checkedChildren={\"Q\"} />\n            </Col>\n            <Col span={10}>\n                <span>Cursor (F): </span>\n                <Radio.Group value={cursorMode} onChange={(e) => setModes(e.target.value, actionMode)} disabled={!inited}>\n                    <Radio.Button value={FALLING} disabled={ValidCursorModes[actionMode].indexOf(FALLING) < 0}>Fall to Edge</Radio.Button>\n                    <Radio.Button value={ADHERE} disabled={ValidCursorModes[actionMode].indexOf(ADHERE) < 0}>Adhere to Edge</Radio.Button>\n                    <Radio.Button value={FLOATING} disabled={ValidCursorModes[actionMode].indexOf(FLOATING) < 0}>Floating</Radio.Button>\n                </Radio.Group>\n            </Col>\n            <Col span={3}>\n                <Button className=\"button\" type=\"danger\" ghost onClick={undo} disabled={!inited}>Undo (Z)</Button>\n            </Col>\n            <Col span={3}>\n                <Button className=\"button\" type=\"primary\" ghost onClick={downloadLabel} disabled={!inited}>Save Label (S)</Button>\n            </Col>\n        </Row>\n    ), [inited, actionMode, cursorMode, downloadLabel, isMovingCanvas, setModes])\n\n    const appearanceRow = useMemo(() => (\n        <Row align={\"middle\"}>\n            <Col span={2} offset={4}><span>Appearance: </span></Col>\n            <Col span={3}>\n                <Switch\n                    disabled={!inited}\n                    checked={composeConfig.showBg}\n                    unCheckedChildren={\"Background\"}\n                    checkedChildren={\"Background\"}\n                    onClick={() => composeUpdate.next({ showBg: !composeConfig.showBg })}\n                />\n                <Slider\n                    disabled={!inited}\n                    min={0}\n                    max={1}\n                    step={0.1}\n                    value={composeConfig.bgWeight}\n                    onChange={(e) => composeUpdate.next({ bgWeight: e as number })}\n                />\n            </Col>\n            <Col span={3} offset={1}>\n                <Row >\n                    <Col span={12}>\n                        <Switch\n                            disabled={!inited}\n                            checked={composeConfig.showEdge}\n                            unCheckedChildren={\"Edge\"}\n                            checkedChildren={\"Edge\"}\n                            onClick={() => composeUpdate.next({ showEdge: !composeConfig.showEdge })}\n                        />\n                    </Col>\n                    <Col span={12}>\n                        <Switch\n                            disabled={!inited}\n                            checked={composeConfig.showEdgeValley && composeConfig.showEdge}\n                            unCheckedChildren={\"Valley\"}\n                            checkedChildren={\"Valley\"}\n                            onClick={() => composeUpdate.next({ showEdgeValley: !composeConfig.showEdgeValley })}\n                        />\n                    </Col>\n                </Row>\n                <Slider\n                    disabled={!inited}\n                    min={0}\n                    max={1}\n                    step={0.1}\n                    value={composeConfig.edgeWeight}\n                    onChange={(e) => composeUpdate.next({ edgeWeight: e as number })}\n                />\n            </Col>\n            <Col span={3} offset={1}>\n                <Switch\n                    disabled={!inited}\n                    checked={composeConfig.showLabel}\n                    unCheckedChildren={\"Label\"}\n                    checkedChildren={\"Label\"}\n                    onClick={() => composeUpdate.next({ showLabel: !composeConfig.showLabel })}\n                />\n                <Slider\n                    disabled={!inited}\n                    min={0}\n                    max={1}\n                    step={0.1}\n                    value={composeConfig.labelWeight}\n                    onChange={(e) => composeUpdate.next({ labelWeight: e as number })}\n                />\n            </Col>\n        </Row>\n    ), [inited, composeConfig])\n\n\n    return (\n        <div className=\"App\">\n            <div className=\"input\">\n                <img id=\"imageSrc\" alt={\"Canvas Input\"} ref={imageSrc} onLoad={onImageLoad} style={{ display: \"none\" }} />\n                <input type=\"file\" id=\"fileInput\" name=\"file\" onChange={(e) => {\n                    imageSrc.current!.src = URL.createObjectURL(e.target.files![0]);\n                }} />\n            </div>\n            {actionRow}\n            {miscRow}\n            {appearanceRow}\n            <div className=\"canvas\">\n                <canvas\n                    id=\"canvas\"\n                    className={isMovingCanvas ? \"moving\" : \"\"}\n                    onMouseEnter={onCanvasMouseEnter}\n                    onMouseLeave={onCanvasMouseLeave}\n                    onMouseMove={onCanvasMouseMove}\n                    onMouseDown={onCanvasMouseDown}\n                    onMouseUp={onCanvasMouseUp}\n                    onKeyPress={onCanvasKeyPress}\n                    onFocus={onCanvasFocus}\n                    onBlur={onCanvasBlur}\n                    onWheel={onCanvasWheel}\n                    onKeyDown={onCanvasKeyDown}\n                    onKeyUp={onCanvasKeyUp}\n                    tabIndex={1000}\n                />\n            </div>\n            <canvas id=\"output\" ref={labelOutput} />\n        </div>\n    );\n}\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      process.env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' }\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n"],"sourceRoot":""}